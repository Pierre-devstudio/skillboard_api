<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Portail Skills — Skillboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }

    body {
      margin: 0;
      background:#f3f4f6;
      color:#111827;
      display:flex;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar {
      width:240px;
      background:#333333;
      color:#e5e7eb;
      display:flex;
      flex-direction:column;
      padding:16px 12px;
      flex-shrink:0;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      z-index:50;
    }
    .sidebar-header {
      font-weight:600;
      font-size:18px;
      margin-bottom:16px;
      text-align:center;
    }
    .sidebar-sub {
      font-size:12px;
      color:#cbd5e1;
      text-align:center;
      margin-bottom:16px;
    }
    .menu {
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:8px;
    }
    .menu-item {
      padding:8px 10px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
      color:#e5e7eb;
      user-select:none;
    }
    .menu-item.active {
      background:#c1272d;
      color:#ffffff;
    }
    .menu-item.disabled {
      opacity:0.4;
      cursor:default;
    }
    .menu-separator {
      margin:10px 6px;
      border-top:1px solid rgba(229,231,235,0.25);
    }

    /* Backdrop mobile */
    .backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.35);
      z-index:40;
      display:none;
    }
    .backdrop.show { display:block; }

    /* Main */
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .topbar {
      background:#ffffff;
      border-bottom:1px solid #e5e7eb;
      padding:10px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .topbar-left {
      font-size:14px;
      color:#4b5563;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .topbar-right {
      font-size:13px;
      color:#6b7280;
      text-align:right;
      flex-shrink:0;
    }

    .menu-toggle {
      display:none;
      border:none;
      background:transparent;
      font-size:20px;
      cursor:pointer;
      color:#111827;
      padding:4px 8px;
      border-radius:6px;
    }

    .content {
      padding:18px;
      overflow:auto;
    }

    .card {
      background:#ffffff;
      border-radius:10px;
      border:1px solid #e5e7eb;
      padding:16px;
      margin-bottom:16px;
    }
    .card-title {
      font-size:16px;
      font-weight:600;
      margin-bottom:8px;
    }
    .card-sub {
      font-size:13px;
      color:#6b7280;
      margin-bottom:10px;
    }

    .row {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:6px;
    }
    .info-item {
      min-width:180px;
      font-size:14px;
      flex:1;
    }
    .label {
      font-size:12px;
      color:#6b7280;
      margin-bottom:2px;
    }
    .value {
      font-size:14px;
      font-weight:500;
      color:#111827;
    }

    .alert {
      padding:10px 12px;
      border-radius:8px;
      font-size:13px;
      margin-bottom:12px;
    }
    .alert.error {
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#991b1b;
    }
    .alert.success {
      background:#ecfdf5;
      border:1px solid #bbf7d0;
      color:#166534;
    }

    .sb-logo {
      max-height: 70px;
      height: auto;
      max-width: 100%;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      width:100%;
      box-sizing:border-box;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font-size:14px;
      background:#ffffff;
    }

    textarea { min-height:72px; resize:vertical; }

    input:focus,
    select:focus,
    textarea:focus {
      outline:none;
      border-color:#c1272d;
      box-shadow:0 0 0 1px rgba(193,39,45,0.20);
    }

    .btn-primary {
      padding:8px 16px;
      border-radius:8px;
      border:0;
      background:#c1272d;
      color:#fff;
      font-size:14px;
      cursor:pointer;
    }
    .btn-secondary {
      padding:8px 16px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:#374151;
      font-size:14px;
      cursor:pointer;
      margin-left:8px;
    }

    .hint {
      font-size:12px;
      color:#6b7280;
      margin-top:6px;
    }
    .hint.error {
      color:#991b1b;
    }

    @media (max-width: 768px) {
      body { flex-direction:column; }

      .sidebar {
        position:fixed;
        top:0;
        left:0;
        height:100vh;
        transform:translateX(-100%);
        box-shadow:0 0 0 rgba(0,0,0,0);
      }
      .sidebar.open {
        transform:translateX(0);
        box-shadow:0 10px 25px rgba(15,23,42,0.6);
      }

      .sidebar-header,
      .sidebar-sub {
        text-align:left;
      }

      .main { flex:1; }
      .topbar { padding:10px 12px; }

      .menu-toggle {
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }
    }
  </style>
</head>

<body>
  <div class="backdrop" id="backdrop"></div>

  <aside class="sidebar" id="sidebar">
    <div>
      <div class="sidebar-header">Espace Skills</div>
      <div class="sidebar-sub">JMB CONSULTANT · Skillboard</div>
    </div>

    <nav class="menu">
      <div class="menu-item active" data-view="dashboard">Dashboard</div>
      <div class="menu-item" data-view="vos-informations">Vos informations</div>
      <div class="menu-item" data-view="votre-organisation">Votre organisation</div>

      <div class="menu-separator"></div>

      <div class="menu-item" data-view="vos-collaborateurs">Vos collaborateurs</div>
      <div class="menu-item" data-view="referentiel-competences">Référentiel de compétences</div>
      <div class="menu-item" data-view="cartographie-competences">Cartographie des compétences</div>
      <div class="menu-item" data-view="analyse-risques">Analyse des risques</div>

      <div class="menu-separator"></div>

      <div class="menu-item" data-view="actions-programmer">Actions à programmer</div>
      <div class="menu-item" data-view="actions-en-cours">Actions en cours</div>
      <div class="menu-item" data-view="actions-passees">Actions passées</div>

      <div class="menu-separator"></div>

      <div class="menu-item" data-view="vos-documents">Vos documents</div>
    </nav>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" id="btnMenuToggle" aria-label="Ouvrir le menu">
          &#9776;
        </button>
        <span id="topbarName">Entreprise</span>
      </div>
      <div class="topbar-right" id="topbarInfo">Chargement…</div>
    </header>

    <main class="content">
      <div id="alertContainer"></div>

      <!-- DASHBOARD -->
      <section id="view-dashboard">
        <div style="text-align:center; margin-bottom:16px;">
          <img src="/Logo_Skillboard.png" alt="Skillboard" class="sb-logo">
        </div>

        <div class="card">
          <div class="card-title" id="welcomeTitle">Bienvenue</div>
          <div class="card-sub" id="welcomeIntro">
            Cet espace vous permet de piloter votre démarche Skills: organisation, référentiel, cartographie, risques, actions et documents.
          </div>
        </div>
      </section>

      <!-- VOS INFORMATIONS -->
      <section id="view-vos-informations" style="display:none;">
        <div class="card">
          <div class="card-title">Vos informations</div>
          <div class="card-sub">
            Mettez à jour vos informations entreprise et vos informations de contact.
          </div>
        </div>

        <!-- ENTREPRISE -->
        <div class="card" id="cardEntreprise">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
            <div>
              <div class="card-title" style="margin-bottom:2px;">Informations entreprise</div>
              <div class="card-sub" style="margin:0;">Le nom de l’entreprise n’est pas modifiable.</div>
            </div>
            <div>
              <button type="button" class="btn-primary" id="btnEditEntreprise">Modifier les informations</button>
              <button type="button" class="btn-primary" id="btnSaveEntreprise" style="display:none;">Enregistrer les informations</button>
              <button type="button" class="btn-secondary" id="btnCancelEntreprise" style="display:none;">Annuler</button>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div class="info-item" style="min-width:260px;">
              <div class="label">Nom entreprise</div>
              <input type="text" id="ent_nom_ent" disabled />
            </div>
            <div class="info-item" style="min-width:220px;">
              <div class="label">SIRET</div>
              <input type="text" id="ent_siret_ent" data-editable-ent="1" />
            </div>
            <div class="info-item" style="min-width:220px;">
              <div class="label">N° TVA</div>
              <input type="text" id="ent_num_tva_ent" data-editable-ent="1" />
            </div>
          </div>

          <div class="row">
            <div class="info-item" style="flex:2; min-width:260px;">
              <div class="label">Adresse (ligne 1)</div>
              <input type="text" id="ent_adresse_ent" data-editable-ent="1" />
            </div>
            <div class="info-item" style="flex:2; min-width:260px;">
              <div class="label">Adresse (complément)</div>
              <input type="text" id="ent_adresse_cplt_ent" data-editable-ent="1" />
            </div>
          </div>

          <div class="row">
            <div class="info-item" style="min-width:120px;">
              <div class="label">Code postal</div>
              <input type="text" id="ent_cp_ent" maxlength="5" inputmode="numeric" data-editable-ent="1" />
            </div>
            <div class="info-item" style="min-width:220px;">
              <div class="label">Ville</div>
              <input type="text" id="ent_ville_ent" data-editable-ent="1" />
            </div>
            <div class="info-item" style="min-width:220px;">
              <div class="label">Pays</div>
              <input type="text" id="ent_pays_ent" data-editable-ent="1" />
            </div>
          </div>

          <div class="row">
            <div class="info-item" style="min-width:220px;">
              <div class="label">Téléphone</div>
              <input type="tel" id="ent_telephone_ent" data-editable-ent="1" />
            </div>
            <div class="info-item" style="flex:2; min-width:260px;">
              <div class="label">Email</div>
              <input type="email" id="ent_email_ent" data-editable-ent="1" />
            </div>
            <div class="info-item" style="flex:2; min-width:260px;">
              <div class="label">Site web</div>
              <input type="text" id="ent_site_web" data-editable-ent="1" />
            </div>
          </div>

          <div class="row">
            <div class="info-item" style="min-width:220px;">
              <div class="label">Code APE (NN.NN)</div>
              <input type="text" id="ent_code_ape_ent" maxlength="5" inputmode="numeric" data-editable-ent="1" />
              <div class="hint" id="apeHint">—</div>
            </div>

            <div class="info-item" style="min-width:220px;">
              <div class="label">IDCC</div>
              <input type="text" id="ent_idcc" inputmode="numeric" data-editable-ent="1" />
              <div class="hint" id="idccHint">—</div>
            </div>

            <div class="info-item" style="min-width:260px;">
              <div class="label">OPCO</div>
              <select id="ent_id_opco" data-editable-ent="1">
                <option value="">(Non renseigné)</option>
              </select>
              <div class="hint" id="opcoHint">—</div>
            </div>
          </div>
        </div>

        <!-- CONTACT -->
        <div class="card" id="cardContact">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
            <div>
              <div class="card-title" style="margin-bottom:2px;">Informations du contact</div>
              <div class="card-sub" style="margin:0;">Contact actuellement connecté.</div>
            </div>
            <div>
              <button type="button" class="btn-primary" id="btnEditContact">Modifier les informations</button>
              <button type="button" class="btn-primary" id="btnSaveContact" style="display:none;">Enregistrer les informations</button>
              <button type="button" class="btn-secondary" id="btnCancelContact" style="display:none;">Annuler</button>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div class="info-item" style="min-width:160px;">
              <div class="label">Civilité</div>
              <select id="ct_civ_ca" data-editable-ct="1">
                <option value="">(Non précisé)</option>
                <option value="M">M.</option>
                <option value="Mme">Mme</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
            <div class="info-item">
              <div class="label">Prénom</div>
              <input type="text" id="ct_prenom_ca" data-editable-ct="1" />
            </div>
            <div class="info-item">
              <div class="label">Nom *</div>
              <input type="text" id="ct_nom_ca" data-editable-ct="1" />
            </div>
          </div>

          <div class="row">
            <div class="info-item">
              <div class="label">Rôle</div>
              <input type="text" id="ct_role_ca" data-editable-ct="1" />
            </div>
            <div class="info-item">
              <div class="label">Téléphone</div>
              <input type="tel" id="ct_tel_ca" data-editable-ct="1" />
            </div>
            <div class="info-item">
              <div class="label">Téléphone (2)</div>
              <input type="tel" id="ct_tel2_ca" data-editable-ct="1" />
            </div>
          </div>

          <div class="row">
            <div class="info-item" style="flex:2; min-width:260px;">
              <div class="label">Email</div>
              <input type="email" id="ct_mail_ca" data-editable-ct="1" />
            </div>
          </div>

          <div class="row">
            <div class="info-item" style="flex:2; min-width:260px;">
              <div class="label">Observations</div>
              <textarea id="ct_obs_ca" data-editable-ct="1"></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- PLACEHOLDERS -->
      <section id="view-votre-organisation" style="display:none;">
        <div class="card">
          <div class="card-title">Votre organisation</div>
          <div class="card-sub">Page à venir: organigramme des services.</div>
        </div>
      </section>

      <section id="view-vos-collaborateurs" style="display:none;">
        <div class="card">
          <div class="card-title">Vos collaborateurs</div>
          <div class="card-sub">Page à venir: liste effectifs + détail.</div>
        </div>
      </section>

      <section id="view-referentiel-competences" style="display:none;">
        <div class="card">
          <div class="card-title">Référentiel de compétences</div>
          <div class="card-sub">Page à venir.</div>
        </div>
      </section>

      <section id="view-cartographie-competences" style="display:none;">
        <div class="card">
          <div class="card-title">Cartographie des compétences</div>
          <div class="card-sub">Page à venir.</div>
        </div>
      </section>

      <section id="view-analyse-risques" style="display:none;">
        <div class="card">
          <div class="card-title">Analyse des risques</div>
          <div class="card-sub">Page à venir.</div>
        </div>
      </section>

      <section id="view-actions-programmer" style="display:none;">
        <div class="card">
          <div class="card-title">Actions à programmer</div>
          <div class="card-sub">Page à venir.</div>
        </div>
      </section>

      <section id="view-actions-en-cours" style="display:none;">
        <div class="card">
          <div class="card-title">Actions en cours</div>
          <div class="card-sub">Page à venir.</div>
        </div>
      </section>

      <section id="view-actions-passees" style="display:none;">
        <div class="card">
          <div class="card-title">Actions passées</div>
          <div class="card-sub">Page à venir.</div>
        </div>
      </section>

      <section id="view-vos-documents" style="display:none;">
        <div class="card">
          <div class="card-title">Vos documents</div>
          <div class="card-sub">Page à venir.</div>
        </div>
      </section>

    </main>
  </div>

  <script>
    const API_BASE = "https://skillboard-services.onrender.com";
    let CONTACT_ID = null;

    let _skillsContextLoaded = false;
    let _infosLoaded = false;

    let _initialEntreprise = null;
    let _initialContact = null;

    let _refOpco = null;

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function showAlert(type, message) {
      const container = document.getElementById("alertContainer");
      if (!message) {
        container.innerHTML = "";
        return;
      }
      container.innerHTML = `<div class="alert ${type}">${message}</div>`;
    }

    function openSidebarMobile() {
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("backdrop");
      sidebar.classList.add("open");
      backdrop.classList.add("show");
    }

    function closeSidebarMobile() {
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("backdrop");
      sidebar.classList.remove("open");
      backdrop.classList.remove("show");
    }

    function switchView(viewName) {
      document.querySelectorAll("section[id^='view-']").forEach(sec => {
        sec.style.display = sec.id === `view-${viewName}` ? "block" : "none";
      });

      document.querySelectorAll(".menu-item").forEach(item => {
        const v = item.getAttribute("data-view");
        item.classList.toggle("active", v === viewName);
      });

      if (viewName === "vos-informations" && CONTACT_ID) {
        ensureInformationsLoaded(CONTACT_ID);
      }

      closeSidebarMobile();
    }

    function setValueOrEmpty(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      el.value = value ?? "";
    }

    function setTextOrDash(id, value, isError) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = (value != null && value !== "") ? value : "—";
      el.classList.toggle("error", !!isError);
    }

    function normalizeValue(v) {
      const s = (v ?? "").toString().trim();
      return s.length === 0 ? null : s;
    }

    function buildPatchFromInitial(initialObj, currentObj, allowedKeys) {
      const patch = {};
      allowedKeys.forEach(k => {
        const a = initialObj ? (initialObj[k] ?? null) : null;
        const b = currentObj ? (currentObj[k] ?? null) : null;

        const aa = (a === "") ? null : a;
        const bb = (b === "") ? null : b;

        if (aa !== bb) patch[k] = bb;
      });
      return patch;
    }

    function setEntrepriseEditMode(isEdit) {
      document.querySelectorAll("[data-editable-ent='1']").forEach(el => {
        el.disabled = !isEdit;
      });

      document.getElementById("btnEditEntreprise").style.display = isEdit ? "none" : "inline-block";
      document.getElementById("btnSaveEntreprise").style.display = isEdit ? "inline-block" : "none";
      document.getElementById("btnCancelEntreprise").style.display = isEdit ? "inline-block" : "none";
    }

    function setContactEditMode(isEdit) {
      document.querySelectorAll("[data-editable-ct='1']").forEach(el => {
        el.disabled = !isEdit;
      });

      document.getElementById("btnEditContact").style.display = isEdit ? "none" : "inline-block";
      document.getElementById("btnSaveContact").style.display = isEdit ? "inline-block" : "none";
      document.getElementById("btnCancelContact").style.display = isEdit ? "inline-block" : "none";
    }

    async function apiJson(url, options) {
      const resp = await fetch(url, options || {});
      const ct = resp.headers.get("content-type") || "";
      const body = ct.includes("application/json") ? await resp.json() : await resp.text();
      if (!resp.ok) {
        const detail = typeof body === "string" ? body : (body.detail || JSON.stringify(body));
        throw new Error(detail);
      }
      return body;
    }

    /* ==========================
       Dashboard context
       ========================== */
    async function loadSkillsContext(id_contact) {
      try {
        showAlert("", "");
        const body = await apiJson(`${API_BASE}/skills/context/${encodeURIComponent(id_contact)}`);

        const civ = (body.civilite || "").trim();
        const prenom = (body.prenom || "").trim();
        const nom = (body.nom || "").trim();
        const display = [civ, prenom, nom].filter(x => x && x.length > 0).join(" ").trim();

        document.getElementById("topbarName").textContent = display || "Contact";
        document.getElementById("topbarInfo").textContent = "Portail Skills — JMB CONSULTANT";
        document.getElementById("welcomeTitle").textContent = display ? `Bienvenue, ${display}` : "Bienvenue";

        _skillsContextLoaded = true;
      } catch (e) {
        showAlert("error", "Erreur de chargement du contexte : " + e.message);
        document.getElementById("topbarInfo").textContent = "Portail Skills — JMB CONSULTANT";
      }
    }

    /* ==========================
       Référentiels
       ========================== */
    async function loadRefOpco() {
      if (_refOpco) return _refOpco;
      _refOpco = await apiJson(`${API_BASE}/skills/referentiels/opco`);
      return _refOpco;
    }

    function renderOpcoSelect(list, selectedId) {
      const sel = document.getElementById("ent_id_opco");
      if (!sel) return;

      const cur = selectedId || "";
      sel.innerHTML = `<option value="">(Non renseigné)</option>`;

      (list || []).forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id_opco;
        opt.textContent = it.nom_opco;
        sel.appendChild(opt);
      });

      sel.value = cur;
    }

    async function lookupIdcc(idcc) {
      const v = (idcc || "").trim();
      if (!v) {
        setTextOrDash("idccHint", "—", false);
        return;
      }
      try {
        const r = await apiJson(`${API_BASE}/skills/referentiels/idcc/${encodeURIComponent(v)}`);
        setTextOrDash("idccHint", r.libelle || "—", false);
      } catch (e) {
        setTextOrDash("idccHint", "IDCC introuvable", true);
      }
    }

    function formatApeInput(raw) {
      let digits = (raw || "").replace(/[^\d]/g, "").slice(0, 4);
      if (digits.length <= 2) return digits;
      return digits.slice(0, 2) + "." + digits.slice(2);
    }

    async function lookupApe(codeApe) {
      const v = (codeApe || "").trim();
      if (!v) {
        setTextOrDash("apeHint", "—", false);
        return;
      }
      try {
        const r = await apiJson(`${API_BASE}/skills/referentiels/ape/${encodeURIComponent(v)}`);
        setTextOrDash("apeHint", r.intitule_ape || "—", false);
      } catch (e) {
        setTextOrDash("apeHint", "Code APE invalide ou introuvable", true);
      }
    }

    function setOpcoHintFromCurrent() {
      const sel = document.getElementById("ent_id_opco");
      if (!sel) return;
      const id = sel.value || "";
      if (!id) {
        setTextOrDash("opcoHint", "—", false);
        return;
      }
      const item = (_refOpco || []).find(x => x.id_opco === id);
      setTextOrDash("opcoHint", item ? item.nom_opco : "—", false);
    }

    /* ==========================
       Chargement / rendu infos
       ========================== */
    function renderEntreprise(ent) {
      setValueOrEmpty("ent_nom_ent", ent.nom_ent);
      setValueOrEmpty("ent_siret_ent", ent.siret_ent);
      setValueOrEmpty("ent_num_tva_ent", ent.num_tva_ent);

      setValueOrEmpty("ent_adresse_ent", ent.adresse_ent);
      setValueOrEmpty("ent_adresse_cplt_ent", ent.adresse_cplt_ent);
      setValueOrEmpty("ent_cp_ent", ent.cp_ent);
      setValueOrEmpty("ent_ville_ent", ent.ville_ent);
      setValueOrEmpty("ent_pays_ent", ent.pays_ent);

      setValueOrEmpty("ent_telephone_ent", ent.telephone_ent);
      setValueOrEmpty("ent_email_ent", ent.email_ent);
      setValueOrEmpty("ent_site_web", ent.site_web);

      setValueOrEmpty("ent_code_ape_ent", ent.code_ape_ent);
      setTextOrDash("apeHint", ent.code_ape_intitule || "—", false);

      setValueOrEmpty("ent_idcc", ent.idcc);
      setTextOrDash("idccHint", ent.idcc_libelle || "—", false);

      setTextOrDash("opcoHint", ent.opco_nom || "—", false);
    }

    function renderContact(ct) {
      const civ = (ct.civ_ca || "").trim();
      const select = document.getElementById("ct_civ_ca");
      if (select) select.value = civ;

      setValueOrEmpty("ct_prenom_ca", ct.prenom_ca);
      setValueOrEmpty("ct_nom_ca", ct.nom_ca);
      setValueOrEmpty("ct_role_ca", ct.role_ca);
      setValueOrEmpty("ct_tel_ca", ct.tel_ca);
      setValueOrEmpty("ct_tel2_ca", ct.tel2_ca);
      setValueOrEmpty("ct_mail_ca", ct.mail_ca);

      const obs = document.getElementById("ct_obs_ca");
      if (obs) obs.value = ct.obs_ca ?? "";
    }

    async function loadInformations(id_contact) {
      showAlert("", "");

      const data = await apiJson(`${API_BASE}/skills/informations/${encodeURIComponent(id_contact)}`);
      const ent = data.entreprise || {};
      const ct = data.contact || {};

      _initialEntreprise = { ...ent };
      _initialContact = { ...ct };

      const opco = await loadRefOpco();
      renderOpcoSelect(opco, ent.id_opco || "");

      renderEntreprise(ent);
      renderContact(ct);

      setEntrepriseEditMode(false);
      setContactEditMode(false);

      _infosLoaded = true;
    }

    async function ensureInformationsLoaded(id_contact) {
      if (_infosLoaded) return;
      try {
        await loadInformations(id_contact);
      } catch (e) {
        showAlert("error", "Erreur de chargement des informations : " + e.message);
      }
    }

    function collectEntrepriseFromUI() {
      return {
        adresse_ent: normalizeValue(document.getElementById("ent_adresse_ent")?.value),
        adresse_cplt_ent: normalizeValue(document.getElementById("ent_adresse_cplt_ent")?.value),
        cp_ent: normalizeValue(document.getElementById("ent_cp_ent")?.value),
        ville_ent: normalizeValue(document.getElementById("ent_ville_ent")?.value),
        pays_ent: normalizeValue(document.getElementById("ent_pays_ent")?.value),
        email_ent: normalizeValue(document.getElementById("ent_email_ent")?.value),
        telephone_ent: normalizeValue(document.getElementById("ent_telephone_ent")?.value),
        site_web: normalizeValue(document.getElementById("ent_site_web")?.value),
        siret_ent: normalizeValue(document.getElementById("ent_siret_ent")?.value),
        code_ape_ent: normalizeValue(document.getElementById("ent_code_ape_ent")?.value),
        num_tva_ent: normalizeValue(document.getElementById("ent_num_tva_ent")?.value),
        idcc: normalizeValue(document.getElementById("ent_idcc")?.value),
        id_opco: normalizeValue(document.getElementById("ent_id_opco")?.value),
      };
    }

    function collectContactFromUI() {
      return {
        civ_ca: normalizeValue(document.getElementById("ct_civ_ca")?.value),
        prenom_ca: normalizeValue(document.getElementById("ct_prenom_ca")?.value),
        nom_ca: normalizeValue(document.getElementById("ct_nom_ca")?.value),
        role_ca: normalizeValue(document.getElementById("ct_role_ca")?.value),
        tel_ca: normalizeValue(document.getElementById("ct_tel_ca")?.value),
        tel2_ca: normalizeValue(document.getElementById("ct_tel2_ca")?.value),
        mail_ca: normalizeValue(document.getElementById("ct_mail_ca")?.value),
        obs_ca: normalizeValue(document.getElementById("ct_obs_ca")?.value),
      };
    }

    async function saveEntreprise(id_contact) {
      const current = collectEntrepriseFromUI();

      const allowed = [
        "adresse_ent","adresse_cplt_ent","cp_ent","ville_ent","pays_ent",
        "email_ent","telephone_ent","site_web",
        "siret_ent","code_ape_ent","num_tva_ent","idcc","id_opco"
      ];

      const patch = buildPatchFromInitial(_initialEntreprise, current, allowed);

      if (Object.keys(patch).length === 0) {
        showAlert("success", "Aucune modification à enregistrer.");
        setEntrepriseEditMode(false);
        return;
      }

      const data = await apiJson(
        `${API_BASE}/skills/informations/entreprise/${encodeURIComponent(id_contact)}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(patch),
        }
      );

      _initialEntreprise = { ...data.entreprise };
      _initialContact = { ...data.contact };

      // refresh affichage + hints
      const opco = await loadRefOpco();
      renderOpcoSelect(opco, data.entreprise.id_opco || "");
      renderEntreprise(data.entreprise);

      showAlert("success", "Informations entreprise enregistrées.");
      setEntrepriseEditMode(false);
    }

    async function saveContact(id_contact) {
      const current = collectContactFromUI();

      const allowed = ["civ_ca","prenom_ca","nom_ca","role_ca","tel_ca","tel2_ca","mail_ca","obs_ca"];
      const patch = buildPatchFromInitial(_initialContact, current, allowed);

      if (patch.nom_ca != null && patch.nom_ca.trim().length === 0) {
        showAlert("error", "Le nom du contact est obligatoire.");
        return;
      }

      if (Object.keys(patch).length === 0) {
        showAlert("success", "Aucune modification à enregistrer.");
        setContactEditMode(false);
        return;
      }

      const data = await apiJson(
        `${API_BASE}/skills/informations/contact/${encodeURIComponent(id_contact)}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(patch),
        }
      );

      _initialEntreprise = { ...data.entreprise };
      _initialContact = { ...data.contact };

      renderContact(data.contact);

      showAlert("success", "Informations du contact enregistrées.");
      setContactEditMode(false);
    }

    function cancelEntrepriseEdits() {
      if (_initialEntreprise) {
        const opco = _refOpco || [];
        renderOpcoSelect(opco, _initialEntreprise.id_opco || "");
        renderEntreprise(_initialEntreprise);
      }
      setEntrepriseEditMode(false);
      showAlert("", "");
    }

    function cancelContactEdits() {
      if (_initialContact) renderContact(_initialContact);
      setContactEditMode(false);
      showAlert("", "");
    }

    window.addEventListener("DOMContentLoaded", () => {
      const id = getQueryParam("id");

      if (!id) {
        showAlert("error", "Identifiant contact manquant dans l’URL. Le lien utilisé n’est pas valide.");
        return;
      }

      CONTACT_ID = id;

      // Menu
      document.querySelectorAll(".menu-item").forEach(item => {
        if (item.classList.contains("disabled")) return;
        item.addEventListener("click", () => {
          const view = item.getAttribute("data-view");
          switchView(view);
        });
      });

      // Hamburger + backdrop
      const btnMenu = document.getElementById("btnMenuToggle");
      const backdrop = document.getElementById("backdrop");

      btnMenu.addEventListener("click", () => {
        const sidebar = document.getElementById("sidebar");
        if (sidebar.classList.contains("open")) closeSidebarMobile();
        else openSidebarMobile();
      });

      backdrop.addEventListener("click", () => closeSidebarMobile());

      // Boutons entreprise
      document.getElementById("btnEditEntreprise").addEventListener("click", async () => {
        try {
          showAlert("", "");
          if (!_infosLoaded) await ensureInformationsLoaded(CONTACT_ID);
          setEntrepriseEditMode(true);
        } catch (e) {
          showAlert("error", e.message);
        }
      });

      document.getElementById("btnCancelEntreprise").addEventListener("click", () => cancelEntrepriseEdits());

      document.getElementById("btnSaveEntreprise").addEventListener("click", async () => {
        try {
          showAlert("", "");
          await saveEntreprise(CONTACT_ID);
        } catch (e) {
          showAlert("error", "Erreur enregistrement entreprise : " + e.message);
        }
      });

      // Boutons contact
      document.getElementById("btnEditContact").addEventListener("click", async () => {
        try {
          showAlert("", "");
          if (!_infosLoaded) await ensureInformationsLoaded(CONTACT_ID);
          setContactEditMode(true);
        } catch (e) {
          showAlert("error", e.message);
        }
      });

      document.getElementById("btnCancelContact").addEventListener("click", () => cancelContactEdits());

      document.getElementById("btnSaveContact").addEventListener("click", async () => {
        try {
          showAlert("", "");
          await saveContact(CONTACT_ID);
        } catch (e) {
          showAlert("error", "Erreur enregistrement contact : " + e.message);
        }
      });

      // APE: format + lookup
      const apeInput = document.getElementById("ent_code_ape_ent");
      apeInput.addEventListener("input", () => {
        const formatted = formatApeInput(apeInput.value);
        apeInput.value = formatted;
      });
      apeInput.addEventListener("blur", async () => {
        await lookupApe(apeInput.value);
      });

      // IDCC: lookup
      const idccInput = document.getElementById("ent_idcc");
      idccInput.addEventListener("blur", async () => {
        await lookupIdcc(idccInput.value);
      });

      // OPCO: hint
      const opcoSel = document.getElementById("ent_id_opco");
      opcoSel.addEventListener("change", () => setOpcoHintFromCurrent());

      // Désactiver champs editables au départ
      setEntrepriseEditMode(false);
      setContactEditMode(false);

      // Vue par défaut
      switchView("dashboard");

      // Charge contexte
      loadSkillsContext(id);
    });
  </script>
</body>
</html>
