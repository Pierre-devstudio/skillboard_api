<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Recueil des Attentes — Skillboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 24px; background:#fafafa; color:#222; }
    h1 { margin: 0 0 16px; font-size: 22px; }
    fieldset { border:1px solid #ddd; border-radius:8px; padding:16px; background:#fff; }
    legend { padding:0 8px; color:#555; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
    .col { display:flex; flex-direction:column; min-width:180px; flex:1; }
    label { font-size:13px; color:#444; margin-bottom:4px; }
    textarea {
      width:100%; min-height:120px; resize:vertical;
      padding:8px; border:1px solid #ccc; border-radius:6px; background:#fff;
    }
    .prerequis-item {
      border-bottom:1px solid #eee; padding:8px 0;
    }
    .prerequis-item:last-child { border-bottom:0; }
    .reponses { display:flex; gap:16px; margin-top:4px; flex-wrap:wrap; }
    .actions { display:flex; gap:10px; margin-top:16px; }
    button {
      padding:10px 14px; border:0; border-radius:8px; cursor:pointer;
    }
    .btn { background:#0ea5e9; color:#fff; }
    .btn.secondary { background:#e2e8f0; color:#111; }
    .muted { color:#666; font-size:16px; }
    .success { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; padding:10px; border-radius:8px; margin-top:16px; }
    .error { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; padding:10px; border-radius:8px; margin-top:16px; }
  </style>
</head>
<body>
  <header style="margin-bottom:20px; text-align:center;">
    <img src="/logo.png" alt="Logo" style="max-height:80px;">
    <div id="formationTitle" style="margin-top:8px; font-weight:600; font-size:22px;"></div>
  </header>

  <h1>Recueil des attentes et autoévaluation</h1>

  <div id="participantInfo" style="font-weight: 600; margin-bottom: 10px;"></div>

  <p class="muted" id="introText">
    Vous êtes inscrit(e) à une formation organisée par JMB Consultant.  
    Merci de décrire vos attentes vis-à-vis de cette formation et d’évaluer votre niveau sur les prérequis indiqués ci-dessous.
  </p>

  <div id="alert"></div>

  <!-- Bloc attentes -->
  <fieldset>
    <legend>Vos attentes personnelles</legend>
    <textarea id="attentes" placeholder="Décrivez ici ce que vous attendez de cette formation..."></textarea>
  </fieldset>

  <div style="height:1px; background:#eee; margin:16px 0;"></div>

  <!-- Bloc autoévaluation -->
  <fieldset>
    <legend>Autoévaluation des prérequis</legend>
    <div id="listePrerequis"></div>
  </fieldset>

  <div class="actions">
    <button class="btn" id="submitBtn">Valider</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // Backend unifié
  const API_BASE = "https://skillboard-services.onrender.com";

  // Supabase (inchangé)
  const SUPABASE_URL = "https://qxupwbbduzufiwvtthkf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dXB3YmJkdXp1Zml3dnR0aGtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzM2OTUsImV4cCI6MjA3MDMwOTY5NX0.sfK-1-HS3EzEjb6lg7a85hekrUDv8Ah3Qgx0j33nWg0";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  function alertBox(type, html) {
    document.querySelector("#alert").innerHTML = `<div class="${type}">${html}</div>`;
  }

  // -------------------- Chargement participant --------------------
  async function chargerParticipant(id_effectif) {
    try {
      const { data, error } = await sb.rpc("rpc_get_participant_from_effectif", {
        p_id_effectif: id_effectif,
      });
      if (error) throw error;

      if (data && data.length > 0) {
        const p = data[0];
        document.getElementById("participantInfo").textContent =
          `${p.civilite} ${p.prenom} ${p.nom}`;
      }
    } catch (error) {
      alertBox("error", "Erreur de chargement du participant : " + error.message);
    }
  }

  // -------------------- Chargement prérequis --------------------
  async function chargerPrerequis(id_effectif) {
    const { data, error } = await sb.rpc("rpc_get_prerequis_from_effectif", {
      p_id_effectif: id_effectif,
    });

    if (error) {
      alertBox("error", "Erreur de chargement des prérequis : " + error.message);
      return;
    }

    const cont = document.getElementById("listePrerequis");
    cont.innerHTML = "";

    data.forEach((pr) => {
      const opts = [pr.r1, pr.r2, pr.r3].filter(Boolean);

      const radios = opts
        .map((r, idx) => {
          const valeur = "r" + (idx + 1); // "r1" / "r2" / "r3"
          return `<label>
            <input type="radio" name="${pr.id_prerequis}" value="${valeur}"> ${r}
          </label>`;
        })
        .join(" ");

      cont.insertAdjacentHTML(
        "beforeend",
        `
        <div class="prerequis-item">
          <div><b>${pr.titre}</b></div>
          <div class="reponses">${radios}</div>
        </div>
        `
      );
    });
  }

  // -------------------- Soumission formulaire --------------------
  async function soumettreFormulaire() {
    const id_effectif = getQueryParam("id");
    if (!id_effectif) {
      alertBox("error", "Lien invalide.");
      return;
    }

    const attentes = document
      .getElementById("attentes")
      .value.trim()
      .replace(/\n/g, "<br>");

    const reponses = [];
    document.querySelectorAll("input[type='radio']:checked").forEach((inp) => {
      const id_prerequis = inp.name;
      const reponse = inp.value; // "r1", "r2", "r3"
      reponses.push({ id_prerequis, reponse });
    });

    const payload = {
      id_action_formation_effectif: id_effectif,
      attentes: attentes,
      json_reponses: reponses,
    };

    try {
      const response = await fetch(`${API_BASE}/recueil_attentes`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const contentType = response.headers.get("content-type") || "";
      const body = contentType.includes("application/json")
        ? await response.json()
        : await response.text();

      if (!response.ok) {
        if (response.status === 409) {
          // cas géré côté API (doublon)
          alertBox(
            "error",
            "Un recueil d'attentes a déjà été enregistré pour ce participant."
          );
          return;
        }

        const detail =
          typeof body === "string"
            ? body
            : body.detail || JSON.stringify(body);
        throw new Error(detail);
      }

      // OK
      alertBox("success", "Merci ! Votre réponse a bien été enregistrée.");
      document.getElementById("submitBtn").disabled = true;
    } catch (e) {
      alertBox("error", "Erreur : " + e.message);
    }
  }

  // -------------------- Wiring évènements --------------------
  document.getElementById("submitBtn").addEventListener("click", (e) => {
    e.preventDefault();
    soumettreFormulaire();
  });

  window.addEventListener("DOMContentLoaded", async () => {
    const id = getQueryParam("id");
    if (!id) {
      alertBox("error", "Identifiant manquant.");
      return;
    }
    chargerParticipant(id);
    chargerPrerequis(id);
  });
</script>

</body>
</html>
